#!/bin/bash
#

SVN="`which svn`"

COMMAND="$1"
shift
NAME="$1"
shift

if test -d "$NAME"; then
    MODE="dir"
else
    MODE="file"
fi

while test $# -gt 0; do
    case "$1" in
        -r)
            shift
            REVISION=$1
        ;;
    esac
    shift
done

if test "$REVISION"; then
    SVN_PATH="`$SVN info "$NAME" -r $REVISION 2>/dev/null | grep "^URL: " | cut -d " " -f 2`"
else
    SVN_PATH="`$SVN info "$NAME" 2>/dev/null | grep "^URL: " | cut -d " " -f 2`"
fi

ORIGINAL_PATH="$SVN_PATH"

function not_found()
{
 echo "**** ERROR: ****"
 echo "Path: $ORIGINAL_PATH"
 echo "Name: $NAME"
 test "$REVISION" && echo "Revision: $REVISION"
 echo "SVN Path not found."
 exit 1
}

function step_up()
{
 test "$MODE" = "file" && not_found
 local new_path="`dirname "$SVN_PATH"`"
 test "$new_path" = "$SVN_PATH" && not_found
 SVN_PATH="$new_path"
}

case "$COMMAND" in
    blame)
        echo "// SVN path: $SVN_PATH"
        echo "// Revision: $REVISION"
        echo
        if test "$REVISION"; then
            $SVN blame "$NAME" -r "$REVISION" 2>&1
        else
            $SVN blame "${NAME}@HEAD" 2>&1
        fi
    ;;
    change)
        while true; do
            $SVN diff "$SVN_PATH" -c "$REVISION" 2>&1
            test $? = 0 && exit
            step_up
        done
    ;;
    diff)
        while true; do
            $SVN diff "$SVN_PATH" -r "$REVISION" 2>&1
            test $? = 0 && exit
            step_up
        done
    ;;
    log)
        while true; do
            $SVN log "$SVN_PATH" -c "$REVISION" 2>&1
            test $? = 0 && exit
            step_up
        done
    ;;
    revert)
        echo "Path: $SVN_PATH" >&2
        echo "Warning: this operation is irreversible!" >&2
        read -p "Do you want to revert it (yes/no)? " yesno
        test "$yesno" = "yes" || exit 1
        $SVN revert "$NAME" 2>&1
    ;;
    *)
        echo "Unhandled mode: '$COMMAND'"
        exit 1
    ;;
esac

